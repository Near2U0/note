[TOC]



#操作系统的启动过程



## BOIS和主引导记录

刚刚开机的时候，会使用的是实模式

### 实模式

* 程序按照8086寻址方式访问0h-fffffh(1M)空间
  * 前面640K(00000-9FFFF)：基本内存
  * 中间128K(A0000-BFFFF)：显卡显存
  * 末尾256K(C0000-FFFFF)：BIOS
    * 显卡BIOS：C0000-C7FFF
    * IDE控制器BIOS：C8000-CBFFF
    * 系统BIOS(64KB)：F0000-FFFFF



* 寻址方式：物理地址(20位)=段地址:偏移地址
* CPU单任务运行





#### 系统BIOS

(Basic I/O System(Firmware，固件))：以硬件方式存在，但是其内部是软件

* 基本输入/输出系统
* 位置:F0000-FFFFF
* 功能
  * 系统启动配置
  * 基本的设备I/O服务
  * 系统的加电自检和启动



* 系统设置界面
	
	通过按下DEl或者F2或者F12，会出现如下的界面：
	
	![image-20190503151040564](/Users/chenyansong/Documents/note/images/os/image-20190503151040564.png)



* BIOS使用的中断类型号为10H-1FH

* 加电自检POST

  * Power On Slef-Test
  * 初始化基本硬件
    * CPU，内存，显卡
  * 自检正常不提示，错误则通过喇叭提示

* 按下PowerOn或者Reset键执行的第一条指令

  * 第一条指令的地址：FFFF0处的指令

    ```
    JUMP POST ; POST位于系统BIOS内部，跳转到加电自检
    ```

  * POST之后。。

  * 查找显卡BIOS,调用显卡BIOS

  * 依次查找其他设备执行相应设备的BIOS

  * 显示启动画面

  * 从硬盘/软盘/U盘读入OS(这个要看设置的启动盘)

  * OS启动后，由OS接管计算机





#### 主启动记录MBR

在BIOS读取启动盘的OS的时候，会首先读启动盘的MBR(512BYTES)

* 存放在硬盘/软盘的首扇区
* 存放和OS启动的相关信息(Main Boot Record)
* 512BYTES
* 结束：0xAA55h(最后两个字节，会以这两个字节结束)

#### MBR/硬盘分区/格式化

![image-20190503153053377](/Users/chenyansong/Documents/note/images/os/image-20190503153053377.png)

* 分区启动扇区(Partition Boot Sector)：BootLoader ，PBR
* 主启动扇区(Main boot sector):完成OS加载或者启动管理功能
  * 提供菜单：让用户选择不同的启动项，实现多重启动
  * 加载核心文件：直接指向可启动区加载操作系统
  * 跳转：将启动管理功能转交给其他loader



综上：

* 1.POST->CMOS(硬盘启动)->读取MBR->控制权交给MBR
* 2.MBR读取分区表(Partition Table)，找到其中的活动分区(Active Partition)，并确认其他的分区都不是活动分区，MBR读取活动分区的第一个分区(分区引导记录PBR)，并把它加载到内存中去
* PBR继续控制后面的引导过程





### 保护模式(内存保护模式，protect mode)

* 寻址方式：段(32位)和偏移量(32位)，寻址4GB空间
  * 段的属性：起始地址，存取属性，权限级别,...
* 段页式寻址机制(段，页)
* 虚拟地址，进程，封闭空间
* 应用程序和操作系统的运行环境都被保护起来了
* CPU支持多任务



## 操作系统的启动过程

### 启动过程

从**加电**到**用户工作环境**准备好的过程：

1. 初始化引导
2. 核心初始化
3. 系统初始化



#### 初始引导

目的：把OS核心装入内存并使之开始工作接管计算机系统

过程：

* 加电，JUMP POST

* BIOS中的启动程序运行

* 启动程序：

  读取0面0道第1扇区内容(MBR)

  加载MBR中的引导程序

* 引导程序(常见的引导程序,如:grub)

  * 根据相关参数,读取硬盘指定位置的文件到内存中
  * 加载硬盘上的OS内核,并初始化基本参数



#### 核心初始化

* 目的:OS内核初始化系统的核心数据
* 典型工作:
  * 各种寄存器的初始化
  * 存储系统和页表的初始化
  * 核心进程构建
  * ...



#### 系统初始化

* 为用户使用系统做准备,使系统处于待命状态
* 主要工作
  * 初始化文件系统
  * 初始化网络系统
  * 初始化控制台
  * 初始化图形界面
  * ...

