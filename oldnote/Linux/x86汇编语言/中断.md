[toc]

中断：打断处理器当前的执行流程，去执行另外一些和当前程序不相干的工作

# 外部硬件中断

从处理器外面来的中断信号

* 外部设备发生错误
* 有数据要传送（从网络中收到一个针对当前主机的数据包）
* 处理器交给外部设备的事情处理完了（比如打印）



外部中断是通过两根信号线引入处理器内部的，这两根线的名字叫：NMI和INTR

![image-20191226193055308](/Users/chenyansong/Documents/note/images/linux/x86/image-20191226193055308.png)

## 非屏蔽中断

像读内存数据错误，或者是IO错误，处理器再工作下去是没有意义的，所以这些中断是要处理器必须立即处理，称之为非屏蔽中断(Non Maskable Interrupt, NMI)，这类中断有一个统一的中断号2

NMI高电平有效，从0跳变到1后，至少需要维持4个以上的时钟周期才算有效，才能被识别



## 可屏蔽中断

在可屏蔽中断前，会有一个代理，用来接收中断，并进行中断仲裁，以决定中断中的哪一个优先向处理器提出服务请求

中断代理，8259芯片（中断控制器），提供15个中断，但是中断号并不固定，该中断控制器芯片有自己的端口号，所以可以通过in和out指令来改变他的状态，所以这个芯片又叫可编程中断控制器（Programmable Interrupt Controller, PIC）

![image-20191226194124911](/Users/chenyansong/Documents/note/images/linux/x86/image-20191226194124911.png)

* 中断屏蔽寄存器（Interrupt Mask Register，IMR），8位寄存器，对应着该芯片的8个中断输入引脚，0表示允许，1表示阻断，没有被阻断的引脚可以送信号到处理器

* 8259芯片的端口号

  * 主片：0x20, 0x21
  * 从片：0xa0, 0xa1

  可以通过这些端口访问8259，设置他的工作方式，包括IMR的内容

* 中断是否被允许，还要看处理器内部的一个中断标志位IF(IF=1,处理器可以接受和响应中断)，可以通过cli（Clear Interrupt flag=0）和sti(SeT Interrupt flag=1)来设置IF的值

* 中断优先级：和引脚相关，主片的IR0引脚优先级最高，IR7优先级最低，从片也是如此



## 实模式下的中断向量表

所谓中断处理，是处理器要执行一段与该中断相关的程序（指令）

## 中断向量表(Interrupt Vector Table, IVT)

* 中断的初始化：是由BIOS在启动时完成的，BIOS为每个中断号填写入口地址，因为他还不知道中断处理程序的位置（此时操作系统和应用程序还没有被加载到内存），所以一律将他们只向一个相同的入口地址，在那里只有一条指令：iret,当操作系统和用户程序需要，再来修改某些中断的入口，使他们只向自定义的中断程序

* 位置：0x0000-0x003ff
* 大小：每个中断向量表占2个字
* 8259芯片中每个引脚都赋予了一个信号（需要以芯片为单位来进行设置），可以指定主片的中断信号从0x08开始，那么每个引脚IR0-IR7所对应的终端信号分别是0x08-0x0f
* 中断时，处理器所做的事情
  * 保护断点现场：FLAGS压栈，清除IF，TF位，CS，IP压栈
  * 执行中断程序，将中断号*4得到中断项，从其中得到中断程序的段地址和偏移地址

![image-20191226201120783](/Users/chenyansong/Documents/note/images/linux/x86/image-20191226201120783.png)



* 中断返回：中断程序的最后一条指令必须是iret,这将导致处理器从栈中弹出IP，CS，FLAGS，接着控制权交给主程序



## 实时时钟, CMOS RAM, BCD编码

外围设备控制芯片ICH内部，集成了实时时钟电路（Real Time Clock, RTC)和静态存储器（CMOS RAM），实时时钟电路负责向CMOS RAM中写入日期和时间数据

* RTC芯片的功能

  * 保存日期和时间
  * 提供闹钟
  * 周期性的终端功能
  * 通常128字节
    * 日期和时间
    * 各种硬件类型和工作参数
    * 开机密码
    * 辅助存储设备的启动顺序
    * 这些通常在BIOS SETUP开机程序中设定

* CMOS RAM中的时间信息

  ![image-20191226204732112](/Users/chenyansong/Documents/note/images/linux/x86/image-20191226204732112.png)









# 内部中断



# 软中断



