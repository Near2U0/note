[toc]

# 计算机加电和复位

处理器会执行一个硬件初始化，以及一个可选的内部自测（BIST），然后将内部所有寄存器的内容初始化到一个预置的状态

对于Intel 8086来说，复位将使代码寄存器（CS）的内容为0xFFFF，其他所有寄存器的内容都为0x0000，包括指令指针寄存器（IP），但是8086之后的处理器并未延续这种设计



# 硬件在内存中的位置

8086有20根地址线，但并非全部用来访问DRAM（内存条），这些地址线经过分配，大部分用于访问DRAM，剩余的部分给了只读存储器ROM和外围的板卡，如下图：

![image-20191221170515403](/Users/chenyansong/Documents/note/images/linux/tixijiegou/image-20191221170515403.png)



![image-20191221173706002](/Users/chenyansong/Documents/note/images/linux/tixijiegou/image-20191221173706002.png)

# 开机自启的代码执行过程

1. 加电复位:CS=0xFFFF, IP=0x0000，所以他的第一条指令位于物理地址为0xFFFF0( cs需要左移4位+IP)，而这个地址正好位于ROM中

2. 在ROM中物理地址为0xFFFF0的地方通常是一个跳转指令，他通过改变CS和IP的内容，是处理器从ROM的高地址跳转到ROM中的低地址处开始执行

   ```assembly
   jmp 0xf000:0xe05b 	;段地址+偏移地址形成的物理地址为：0xfe05b
   ```
   
   > 这里我们要区分8086和他之后的处理器(32为地址线)的区别：
   >
   > 8086加电是CS=0xFFFF; IP=0x0000，所以第一条指令的地址为：0xFFFF0 (此时CS需要左移4位，满足20位地址线)
   >
   > 32位：CS=0xF000; IP=0xFFF0, 所以低20位为0xFFFF0 (同样需要左移4位），但是刚刚启动的时候，处理器将其余（高位部分）的地址线强制为高电平，因为Bochs虚拟机的地址线为32根，所以初始的物理内存地址就是：0x0000fffffff0 (低32位是有效位)
   
   ![image-20191223204309835](/Users/chenyansong/Documents/note/images/linux/tixijiegou/image-20191223204309835.png)
   
3. 当ROM-BIOS完成自己的使命（开机自检）之后，从外存储设备读取更多的指令来交给处理器执行，假设硬盘是首选，那么此时BIOS将读取硬盘主引导扇区（0面0道1扇区）的内容（512字节），并将它加载到内存地址：0x0000:0x7c00处（也就是物理地址0x07c00处），然后jmp跳转到MBR处执行
  
   ```assembly
   jmp 0x0000:0x7c00
   ```
   
4. MBR会将安装的"启动管理器"（boot loader）加载到内存，然后由boot将操作系统的代码加载到内存，将控制权交给操作系统
  

   ![image-20191222091642061](/Users/chenyansong/Documents/note/images/linux/tixijiegou/image-20191222091642061.png)





> 在ROM芯片中包括很多部分，主要进行硬件的诊断，检测和初始化，最后他还负责提供一套软件例程
>
> 有了这些例程：程序员可以在不了解硬件细节的情况下从外围设备（比如键盘）获取输入数据，或者向外围设备（比如显示器）输出数据
>
> 因为外围设备是很多的，但是ROM芯片只是提供了最基本的，对于使用计算机而言最重要的设备，而他所提供的软件例程，也只包括最基本，最常规的功能，正因为如此，这块芯片又叫基本输入输出系统（Base Input & Output System， BIOS) ROM