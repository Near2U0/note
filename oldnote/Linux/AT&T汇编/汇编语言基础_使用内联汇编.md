[toc]

内联汇编：inline assembly

# C语言转换成汇编

以下是一段C语言代码

```c
#include <stdio.h>

float circumf(int a)
{
  return 2 * a * 3.14159;
}
float area(int a)
{
  return a * a * 3.14159;
}

int main()
{
  int x = 10;
  printf("Radius : %d\n", x);
  printf("Cirumference: %f\n", cirumf(x));
  printf("Area: %f\n", area(x));
  
  return 0;
}
```

编译器生成汇编如下

```shell
gcc -S cfunctest.c
```

![image-20200219204310117](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219204310117.png)

![image-20200219204345513](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219204345513.png)

![image-20200219204401665](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219204401665.png)



# 基本的内联汇编代码

## asm格式

* 指令必须括在引号里
* 如果包含的指令超过一条，那么必须使用新行字符分隔汇编语言代码的每一行，通常还包含制表符缩进汇编语言代码，使代码更容易阅读

```c
asm("assembly code");

#当有多行时
asm("movl $1, %eax\n\t"
		"movl $0, %ebx\n\t"
		"int $0x80"
);
```

asm段可以被放在C或者C++源代码中的任何地方



## 在C中使用asm

![image-20200219210145725](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219210145725.png)

编译成汇编代码如下：

![image-20200219210436073](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219210436073.png)

![image-20200219210301431](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219210301431.png)

> 内嵌的asm代码包含在APP和NO_APP中间



## 使用全局C变量

只有全局定义的变量才能在基本的内联汇编代码内使用，不能在asm段中使用局部变量

![image-20200219211333367](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219211333367.png)

> 在asm中使用了寄存器，所以使用之前要先pusha，使用之后要popa，防止出错

编译的汇编代码如下：

![image-20200219211448515](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219211448515.png)

![image-20200219211531269](/Users/chenyansong/Documents/note/images/linux/assemly/image-20200219211531269.png)



## 使用volatile修饰符

编译器会优化代码的排版以实现更好的程序流程，如果希望编译器不处理手动编码的内嵌汇编函数，可以使用volatile明确说明

```c
asm volatile ("assembly code");
```



## 使用替换的关键字

ANSI规范把关键字asm用于其他用途，不能将他用于内嵌汇编语句，如果使用ANSI C约定编写代码，你必须使用关键字 `__asm__`替换一般的关键字asm，如下：

```c
__asm__ ("movl $1, %eax\n\t"
		"movl $0, %ebx\n\t"
		"int $0x80"
);
```

> 关键字 `__asm__`也可以使用修饰符 `__volatile__`进行修饰



# 扩展asm

