# 6.版本升级

es通常可以使用滚动升级的过程，来保证服务的不中断，下面介绍如何使用滚动升级与集群的升级重启，es不是所有的版本都可以直接升级，升级前请先查阅相关文档，**然后进行数据备份**，最好在测试环境下模拟一遍，升级可以参照以下内容：

* 从0.90x到2.x需要全集群重启
* 从1.x到2.x需要全集群重启
* 从2.x到2.y可以不用全部重启，使用滚动升级完成（y>x)

在升级的时候同时要考虑插件的问题，最好是插件的版本和es的版本一致

在每个节点上升级和重启的过程为：

1.关闭es
2.升级es
3.升级插件
4.重启es

## 6.1.重启集群

1.关闭分片分配
当我们试图关闭一个节点的时候，es会立即试图复制这个节点的数据到集群中的其他节点上，这将导致大量的IO请求，所以在关闭节点的时候，可以通过设置以下参数来避免此问题的发生：

```
PUT /_cluster/settings{
  "transient":{"cluster.routing.allocation.enable":"none"}
}
```

2.执行一个同步刷新

当停止一个索引的时候，分片的恢复会很快，所以要进行同步刷新请求
```
PUT _flush/synced
```
同步刷新请求是一个非常有效的操作，当任何索引操作失败的时候，可以执行同步刷新请求，必要的时候可以执行多次

3.关闭和升级所有结点

停止在集群中的所有节点的服务，每一个节点都要进行单独升级，这个主要是文件的替换操作，注意保留日志目录

4.启动集群

如果你有专门的主节点（node.master设置为true，node.data设置为false),则优先启动主节点，等待他们形成一个集群，然后选择一个主数据节点进行启动，你可以通过查看日志来检查启动情况，通过下面的命令可以查看集群的启动情况，检查所有节点是否已经成功加入集群

```
GET /_cat/health
GET /_cat/nodes
```

5.等待黄色集群状态

当节点加入到集群以后，首先恢复存储在本地的主分片数据，最初的时候，通过_cat/health请求发现集群的状态是红色，意味着不是所有的主分片都已经分配，当每个结点都恢复完成后，集群的状态会变成黄色，这意味着所有主分片都已经被找到，但是并不是所有的副本分片都恢复了

6.重新分配

延迟副本的分配直到所有的节点都加入集群，在集群的所有结点可以重新启用碎片分配
```
PUT /_cluster/settings{
  "transient":{"cluster.routing.allocation.enable":"all"}
}
```

这个时候集群将开始复制所有副本到数据节点上，这样可以安全的恢复索引和搜索，如果你能延迟索引和搜索直到所有分片已经恢复，这样就可以加快集群的恢复，可以通过下面的API监控恢复的进度和健康情况：
```
GET /_cat/health
GET _cat/recovery
```

当集群状态出现绿色的时候，表示本次集群升级全部完成

# 6.2.滚动升级

滚动升级允许es升级集群的一个节点，又不影响集群的时候，在同一个集群中的所有结点的版本最好保持一致，否则可能会产生不可预知的后果，滚动升级的步骤如下：


1.关闭分片分配
当我们试图关闭一个节点的时候，es会立即试图复制这个节点的数据到集群中的其他节点上，这将导致大量的IO请求，所以在关闭节点的时候，可以通过设置以下参数来避免此问题的发生：

```
PUT /_cluster/settings{
  "transient":{"cluster.routing.allocation.enable":"none"}
}
```

2.停止不必要的索引和执行一个同步刷新

当停止一个索引的时候，分片的恢复会很快，所以要进行同步刷新请求
```
PUT _flush/synced
```
同步刷新请求是一个非常有效的操作，当任何索引操作失败的时候，可以执行同步刷新请求，必要的时候可以执行多次

3.停止和升级一个节点

在启动升级前，将集群中的一个节点关闭，可以通过绿色解压安装或者通过RPM等安装包安装，不管是解压安装还是压缩包安装都要保留之前的数据文件不能被破坏，**可以在新目录中让path.conf和path.data的位置指向之前的数据**

4.启动升级节点

启动升级节点，并通过节点检查是否正确
```
GET /_cat/nodes
```

5.启用共享设置

一旦节点加入集群，在节点重新启用碎片分配
```
PUT /_cluster/settings{
  "transient":{"cluster.routing.allocation.enable":"all"}
}
```


6.等待节点恢复

应该在集群下一个节点升级之前完成碎片分配，可以通过以下接口进行检查
```
GET /_cat/health
```
等待的状态从黄色变成绿色，意味着所有主分片和副本分片已经完成分配

**在滚动升级期间，主分片被分配到一个更高版本的节点，不会有副本分配到一个较低的节点版本，因为旧版本可能不能识别新版本的数据结构**


7.恢复其他节点

当集群是稳定的，节点已经恢复，重复上述步骤，把所有剩余节点进行升级

